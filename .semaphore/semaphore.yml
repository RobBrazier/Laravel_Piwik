version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:
  prologue:
    commands:
      - checkout
      - source ~/.phpbrew/bashrc
      - export PATH="$PATH:~/.local/bin"
      - bash .semaphore/install_php
      - phpbrew switch $PHP_VERSION +default
      - bash .semaphore/install_composer
      - export COMPOSER_HASH="$(md5sum composer.lock | awk -F' ' '{ print $1 }')"

blocks:
  - name: "Install"
    task:
      jobs:
      - name: Install Dependencies
        matrix:
          - env_var: PHP_VERSION
            values: [ "7.3", "7.4", "8.0" ]
        commands:
          - cache restore composer-semaphore-$COMPOSER_HASH-$PHP_VERSION
          - composer install
          - cache store composer-semaphore-$COMPOSER_HASH-$PHP_VERSION vendor/

  - name: "Unit Tests"
    task:
      jobs:
        - name: Run Unit Tests
          matrix:
            - env_var: PHP_VERSION
              values: [ "7.3", "7.4", "8.0" ]
          commands:
            - cache restore composer-semaphore-$COMPOSER_HASH-$PHP_VERSION
            - composer run-script test

  - name: "Upload Test Coverage"
    task:
      env_vars:
        - name: PHP_VERSION
          value: "7.4"
#        - name: SONAR_SCANNER_VERSION
#          value: "4.7.0.2747"
#        - name: SONAR_SCANNER_OPTS
#          value: "-server"
      secrets:
        - name: codacy-laravel-piwik
#        - name: sonarcloud-token
      jobs:
        - name: Codacy Test Coverage
          commands:
            - cache restore composer-semaphore-$COMPOSER_HASH-$PHP_VERSION
            - composer run-script coverage
            - exitCode=$?
            - cp reports/coverage.xml clover.xml
            - bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r clover.xml
#        - name: SonarCloud Scan
#          commands:
#            - export SONAR_SCANNER_HOME="$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux"
#            - cache restore composer-semaphore-$COMPOSER_HASH-$PHP_VERSION
#            - composer run-script coverage
#            - exitCode=$?
#            - curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
#            - unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
#            - $SONAR_SCANNER_HOME/bin/sonar-scanner -Dsonar.organization=robbrazier -Dsonar.projectKey=RobBrazier_Laravel_Piwik -Dsonar.sources=src -Dsonar.tests=./tests -Dsonar.host.url=https://sonarcloud.io -Dsonar.php.coverage.reportPaths=reports/coverage.xml

  - name: "Integration Tests"
    task:
      env_vars:
        - name: PHP_VERSION
          value: "7.4"
      jobs:
        - name: Run Laravel Integration Test
          matrix:
            - env_var: LARAVEL_VERSION
              values: [ "5.1", "5.2", "5.3", "5.4", "5.5", "5.6", "5.7", "5.8", "6.0", "7.0", "8.0" ]
          commands: 
            - bash .semaphore/integration_test

promotions:
  - name: Publish
    pipeline_file: publish.yml
    auto_promote_on:
      - result: passed
        branch:
            - master
            - docs