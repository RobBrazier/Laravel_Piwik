version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:
  prologue:
    commands:
      - composer self-update

blocks:
  - name: "Build"
    task:
      jobs:
      - name: Build
        matrix:
          - env_var: PHP_VERSION
            values: [ "7.0", "7.1", "7.2", "7.3" ]
        commands:
          - export PHPBREW_DIR="$HOME/.phpbrew/php/$PHP_VERSION"
          - export PHPBREW_VERSION="phpbrew-$PHP_VERSION"
          - if cache has_key $PHPBREW_VERSION; then cache restore $PHPBREW_VERSION; else phpbrew --no-progress install --name $PHP_VERSION $PHP_VERSION; cache store $PHPBREW_VERSION $PHPBREW_DIR; fi
          - phpbrew switch $PHP_VERSION
          - php --version
          - checkout
          - cache restore
          - composer install
          - cache store

  # - name: "Smoke tests"
  #   task:
  #     jobs:
  #     - name: Smoke
  #       commands:
  #         - checkout
  #         - echo "make smoke"

  # - name: "Unit tests"
  #   task:
  #     jobs:
  #     - name: RSpec
  #       commands:
  #         - checkout
  #         - echo "make rspec"

  #     - name: Lint code
  #       commands:
  #         - checkout
  #         - echo "make lint"

  #     - name: Check security
  #       commands:
  #         - checkout
  #         - echo "make security"

  # - name: "Integration tests"
  #   task:
  #     jobs:
  #     - name: Cucumber
  #       commands:
  #         - checkout
  #         - echo "make cucumber"

  # - name: "Push Image"
  #   task:
  #     jobs:
  #     - name: Push
  #       commands:
  #         - checkout
  #         - echo "make docker.push"
