version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:
  prologue:
    commands:
      - composer self-update

blocks:
  - name: "Install"
    task:
      prologue:
        commands: 
          - checkout
          - bash .semaphore/switch_php
      jobs:
      - name: Build
        matrix:
          - env_var: PHP_VERSION
            values: [ "7.0", "7.1", "7.2", "7.3" ]
        commands:
          - php --version
          - export COMPOSER_HASH="$(md5sum composer.lock | awk -F' ' '{ print $1 }')"
          - cache restore composer-semaphore-$COMPOSER_HASH-$PHP_VERSION
          - composer install
          - cache store composer-semaphore-$COMPOSER_HASH-$PHP_VERSION vendor/

  # - name: "Smoke tests"
  #   task:
  #     jobs:
  #     - name: Smoke
  #       commands:
  #         - checkout
  #         - echo "make smoke"

  # - name: "Unit tests"
  #   task:
  #     jobs:
  #     - name: RSpec
  #       commands:
  #         - checkout
  #         - echo "make rspec"

  #     - name: Lint code
  #       commands:
  #         - checkout
  #         - echo "make lint"

  #     - name: Check security
  #       commands:
  #         - checkout
  #         - echo "make security"

  # - name: "Integration tests"
  #   task:
  #     jobs:
  #     - name: Cucumber
  #       commands:
  #         - checkout
  #         - echo "make cucumber"

  # - name: "Push Image"
  #   task:
  #     jobs:
  #     - name: Push
  #       commands:
  #         - checkout
  #         - echo "make docker.push"
