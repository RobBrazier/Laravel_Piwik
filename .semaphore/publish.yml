version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:
  prologue:
    commands:
      - export PATH="$HOME/.config/composer/vendor/bin:$PATH"

blocks:
  # - name: Create new GitHub Release
  #   task:
  #     secrets:
  #       - name: gh-token
  #     jobs:
  #       - name: Create Release
  #         commands:
  #           - checkout
  #           - sem-version node 12
  #           - bash .semaphore/release
  - name: Build Docs
    task:
      jobs:
        - name: Build MkDocs
          commands:
            - checkout
            - CACHE_KEY="mkdocs-$SEMAPHORE_GIT_SHA"
            - if cache has_key $CACHE_KEY; then exit 0; fi
            - pip3 install -r docs/requirements.txt
            - python3 -m mkdocs build
            - cache store $CACHE_KEY build/
        - name: Build Doctum
          commands:
            - checkout
            - CACHE_KEY="doctum-$SEMAPHORE_GIT_SHA"
            - if cache has_key $CACHE_KEY; then exit 0; fi
            - composer global require "code-lts/doctum"
            - git pull --tags
            - doctum.php update .doctum.php || true
            - mkdir -p build
            - mv ../docs/api ./build/api
            - cache store $CACHE_KEY build/api/
  
  - name: Publish Docs
    task:
      secrets:
        - name: laravel-piwik-bunnycdn-ftp
      jobs:
        - name: Deploy
          commands:
            - checkout
            - cache restore mkdocs-$SEMAPHORE_GIT_SHA
            - cache restore doctum-$SEMAPHORE_GIT_SHA
            - bash .semaphore/deploy_docs.sh
  
  - name: "Clear Cache"
    task:
      secrets:
        - name: bunnycdn-api-key
      jobs:
      - name: Clear Cache
        commands:
          - curl -X POST -H 'Content-Length:0' -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/pullzone/571491/purgeCache" --verbose
          - curl -X POST -H 'Content-Length:0' -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/pullzone/571493/purgeCache" --verbose